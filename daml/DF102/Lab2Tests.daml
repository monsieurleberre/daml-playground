module DF102.Lab2Tests where 

import Daml.Script
import DF102.Lab2
import DA.Date (toDateUTC, date, Month(Jan), Month(Mar))
import DA.Time (time)

testSubmitAndAcceptCLPApplication: Script () 
testSubmitAndAcceptCLPApplication = script do 
    alice <- allocateParty "Alice"
    airline <- allocateParty "Epic Airlines"
    
    setTime (time (date 2023 Mar 01) 10 30 0)
    now <- getTime 

    -- Alice creates a blank CLPApplication
    aliceCLPApplication1 <- submit alice do         
        createCmd CLPApplication with  
            customer = alice 
            airline = airline 
            id = "123"
            name = "Alice"
            address = "Wonderland"
            email = "alice@wonderland.io"
            phone = Some "123-456-7890"
            appTimestamp = now 
            dob = toDateUTC now

    -- Alice submits the application with details filled in
    aliceCLPApplication1 <- submit alice do 
        exerciseCmd aliceCLPApplication1 SubmitApplication 

    -- Airline reviews application. This should result in a new CLPAccount for Alice
    aliceCLPAccount <- submit airline do 
        exerciseCmd aliceCLPApplication1 ReviewApplication 

    -- Alice creates another blank application
    aliceCLPApplication2 <- submit alice do         
        createCmd CLPApplication with  
            customer = alice 
            airline = airline 
            id = "123"
            name = "Alice"
            address = "Wonderland"
            email = "alice@wonderland.org"
            phone = Some "123-456-7890"
            appTimestamp = now 
            dob = toDateUTC now

   -- Alice submits another application with details filled in with the same 'id'
    aliceCLPApplication2 <- submit alice do 
        exerciseCmd aliceCLPApplication2 SubmitApplication 

    -- Airline reviews it but no new account for Alice should be created
    aliceClpAccount2 <- submit airline do 
        exerciseCmd aliceCLPApplication2 ReviewApplication 

    return()